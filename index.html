<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ãƒ³ãƒ€ãƒ ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿã‚·ã‚¹ãƒ†ãƒ  (Auto MP3)</title>
    <style>
        /* --- åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š --- */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #222;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
        h2 { font-size: 1.1rem; border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 0; }
        
        .control-group { margin-bottom: 15px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        
        select, input[type="text"], input[type="range"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: #444;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #555 !important; cursor: not-allowed; }

        /* --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œéƒ¨ --- */
        .btn-play { background-color: #28a745; width: 48%; }
        .btn-stop { background-color: #dc3545; width: 48%; }
        .player-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        
        .status-box {
            margin-top: 15px;
            padding: 10px;
            background: #222;
            border-radius: 5px;
            font-family: monospace;
            text-align: center;
            color: #00ffcc;
        }

        /* --- è¨­å®šã‚¨ãƒªã‚¢ --- */
        .settings-area {
            border: 1px solid #555;
            padding: 15px;
            border-radius: 8px;
            background: #2a2a2a;
        }

        .list-container {
            max-height: 150px;
            overflow-y: auto;
            background: #222;
            border: 1px solid #444;
            padding: 5px;
            margin-bottom: 10px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }
        .list-item:last-child { border-bottom: none; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; background: #666; }
        .btn-add { background: #007bff; width: 100%; margin-top: 5px; }
        .btn-save { background: #17a2b8; width: 100%; margin-top: 10px; }
        
        .file-select-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        .file-checkbox {
            background: #444;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            user-select: none;
        }
        .file-checkbox input { margin-right: 5px; }
        .file-checkbox.checked { background: #0056b3; }

        details { margin-bottom: 10px; }
        summary { cursor: pointer; color: #aaa; font-size: 0.9rem; outline: none; }
        summary:hover { color: #fff; }

        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .hidden { display: none; }
        .small-note { font-size: 0.75rem; color: #aaa; margin-top: 2px; }

    </style>
</head>
<body>

    <h1>ğŸ”Š Random Sound Player</h1>

    <div class="container">
        
        <div class="card">
            <h2>å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
            
            <div class="control-group">
                <label>å†ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—</label>
                <select id="mainGroupSelect"></select>
                
                <label style="display:flex; align-items:center; margin-top:8px; font-weight:normal;">
                    <input type="checkbox" id="reduceRepeat" checked style="width:auto; margin-right:5px;">
                    å‰å›ã¨åŒã˜éŸ³ã®ç¢ºç‡ã‚’ä¸‹ã’ã‚‹ (50%)
                </label>
            </div>

            <div class="control-group">
                <div class="row">
                    <div class="col">
                        <label>éŸ³é‡: <span id="volDisplay">50%</span></label>
                        <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <div class="col">
                        <label>é–“éš”: <span id="intervalDisplay">1.5ç§’</span></label>
                        <input type="range" id="intervalRange" min="0.2" max="5.0" step="0.1" value="1.5">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <details>
                    <summary>ç¢ºç‡è©³ç´°è¨­å®šã‚’é–‹ã</summary>
                    <div style="padding-top: 10px;">
                        <label>ç¢ºç‡å¢—åŠ ãƒ¢ãƒ¼ãƒ‰</label>
                        <div class="row" style="margin-bottom:10px;">
                            <label style="font-weight:normal;"><input type="radio" name="probMode" value="linear" checked> â• ç­‰é€Ÿ</label>
                            <label style="font-weight:normal;"><input type="radio" name="probMode" value="exponential"> ğŸš€ æŒ‡æ•°</label>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>åˆæœŸç¢ºç‡(%)</label>
                                <input type="number" id="initProb" value="10" min="0.1" max="100" step="0.1">
                            </div>
                            <div class="col" id="linearSetting">
                                <label>å¢—åŠ é‡(+%)</label>
                                <input type="number" id="stepProb" value="10" min="0" max="100">
                            </div>
                            <div class="col hidden" id="exponentialSetting">
                                <label>å€ç‡(Ã—)</label>
                                <input type="number" id="multiProb" value="1.5" step="0.1">
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <div class="player-buttons">
                <button id="startBtn" class="btn-play">é–‹å§‹</button>
                <button id="stopBtn" class="btn-stop" disabled>åœæ­¢</button>
            </div>

            <div class="status-box" id="statusDisplay">è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</div>
        </div>

        <div class="card">
            <h2>ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h2>
            
            <details open>
                <summary>ğŸ“‚ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ² (soundãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«å)</summary>
                <div class="settings-area">
                    <div class="list-container" id="fileListContainer">
                        </div>
                    <div class="row">
                        <input type="text" id="newFileName" placeholder="ä¾‹: bell (.mp3ã¯ä¸è¦)">
                        <input type="file" id="filePicker" accept=".mp3" style="display:none;">
                        <button class="btn-sm" id="browseBtn" style="background:#6c757d; width: 60px;" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦åå‰ã‚’å…¥åŠ›">ğŸ“‚ å‚ç…§</button>
                        <button class="btn-sm" id="addFileBtn" style="background:#28a745;">è¿½åŠ </button>
                    </div>
                    <div class="small-note">â€» ã€Œå‚ç…§ã€ã¾ãŸã¯å…¥åŠ›å¾Œã€Œè¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã¯æ‰‹å‹•ã§ sound ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚</div>
                    <div class="small-note">â€» å…¥åŠ›å¾Œã€è‡ªå‹•çš„ã« .mp3 ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</div>
                </div>
            </details>

            <details style="margin-top:10px;">
                <summary>ğŸ—‚ï¸ ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</summary>
                <div class="settings-area">
                    <div class="control-group">
                        <label>ç·¨é›†ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ (ã¾ãŸã¯æ–°è¦ä½œæˆ)</label>
                        <div class="row">
                            <select id="editGroupSelect"></select>
                            <button id="deleteGroupBtn" class="btn-sm" style="background:#dc3545; width:60px;">å‰Šé™¤</button>
                        </div>
                        <div class="row" style="margin-top:5px;">
                            <input type="text" id="newGroupName" placeholder="æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—å">
                            <button id="createGroupBtn" class="btn-sm" style="background:#007bff; width:60px;">ä½œæˆ</button>
                        </div>
                    </div>

                    <div id="groupEditorArea" class="hidden">
                        <label>ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                        <div class="file-select-area" id="groupFileCheckboxes">
                        </div>
                        <button id="saveGroupConfigBtn" class="btn-save">ã‚°ãƒ«ãƒ¼ãƒ—å†…å®¹ã‚’ä¿å­˜</button>
                    </div>
                </div>
            </details>

            <details style="margin-top:10px;">
                <summary>ğŸ’¾ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ãƒ»èª­è¾¼</summary>
                <div class="settings-area">
                    <p style="font-size:0.9rem; margin:0 0 10px;">ç¾åœ¨ã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã¾ãŸã¯èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
                    <div class="row">
                        <button id="exportBtn" class="btn-sm" style="background:#17a2b8; flex:1;">è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜(DL)</button>
                        <label class="btn-sm" style="background:#6c757d; flex:1; text-align:center; cursor:pointer; margin:0;">
                            è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼
                            <input type="file" id="importFile" accept=".json" style="display:none;">
                        </label>
                    </div>
                </div>
            </details>
        </div>

    </div>

    <script>
        /* * ============================================================
         * ğŸ“¦ ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨åˆæœŸè¨­å®š
         * ============================================================
         */
        const defaultData = {
            files: ["breach.mp3", "kayo.mp3", "phoenix.mp3", "skye.mp3", "yoru.mp3"],
            groups: [
                { name: "å…¨ã¦", files: ["breach.mp3", "kayo.mp3", "phoenix.mp3", "skye.mp3", "yoru.mp3"] },
                { name: "ã‚¤ãƒ‹ã‚·ã‚¨ãƒ¼ã‚¿ãƒ¼", files: ["breach.mp3", "kayo.mp3", "skye.mp3"] },
                { name: "ãƒ‡ãƒ¥ã‚¨ãƒªã‚¹ãƒˆ", files: ["phoenix.mp3", "yoru.mp3"] },
                { name: "breach", files: ["breach.mp3"] },
                { name: "kayo", files: ["kayo.mp3"] },
                { name: "phoenix", files: ["phoenix.mp3"] },
                { name: "skye", files: ["skye.mp3"] },
                { name: "yoru", files: ["yoru.mp3"] }
            ]
        };

        let appData = { files: [], groups: [] };

        /* * ============================================================
         * ğŸ”§ DOMè¦ç´ 
         * ============================================================
         */
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDisplay = document.getElementById('statusDisplay');
        const mainGroupSelect = document.getElementById('mainGroupSelect');
        const reduceRepeatCheck = document.getElementById('reduceRepeat');
        const volumeRange = document.getElementById('volumeRange');
        const intervalRange = document.getElementById('intervalRange');
        
        const fileListContainer = document.getElementById('fileListContainer');
        const newFileNameInput = document.getElementById('newFileName');
        const addFileBtn = document.getElementById('addFileBtn');
        const filePicker = document.getElementById('filePicker');
        const browseBtn = document.getElementById('browseBtn');
        
        const editGroupSelect = document.getElementById('editGroupSelect');
        const newGroupNameInput = document.getElementById('newGroupName');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const deleteGroupBtn = document.getElementById('deleteGroupBtn');
        const groupEditorArea = document.getElementById('groupEditorArea');
        const groupFileCheckboxes = document.getElementById('groupFileCheckboxes');
        const saveGroupConfigBtn = document.getElementById('saveGroupConfigBtn');
        
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');

        const initProbInput = document.getElementById('initProb');
        const stepProbInput = document.getElementById('stepProb');
        const multiProbInput = document.getElementById('multiProb');
        const probModeRadios = document.getElementsByName('probMode');

        let isRunning = false;
        let timerId = null;
        let currentProbability = 0;
        let lastPlayedFile = null;

        /* * ============================================================
         * ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜
         * ============================================================
         */
        function initApp() {
            const savedData = localStorage.getItem('soundPlayerConfig');
            if (savedData) {
                appData = JSON.parse(savedData);
            } else {
                appData = JSON.parse(JSON.stringify(defaultData)); 
            }
            refreshAllUI();
        }

        function saveData() {
            localStorage.setItem('soundPlayerConfig', JSON.stringify(appData));
            refreshAllUI();
        }

        function refreshAllUI() {
            renderFileList();
            renderGroupSelects();
            renderGroupEditor();
        }

        /* * ============================================================
         * ğŸ–¥ï¸ UIæ“ä½œãƒ­ã‚¸ãƒƒã‚¯
         * ============================================================
         */

        // 1. ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
        function renderFileList() {
            fileListContainer.innerHTML = '';
            appData.files.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${file}</span>
                    <button class="btn-sm" style="background:#dc3545;" onclick="removeFile(${index})">å‰Šé™¤</button>
                `;
                fileListContainer.appendChild(div);
            });
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        window.removeFile = (index) => {
            if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${appData.files[index]}ã€ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const fileName = appData.files[index];
                appData.groups.forEach(g => {
                    g.files = g.files.filter(f => f !== fileName);
                });
                appData.files.splice(index, 1);
                saveData();
            }
        };

        function registerFile(fileName) {
            let name = fileName.trim();
            if (!name) return;
        
            // mp3æ‹¡å¼µå­ã®ãƒã‚§ãƒƒã‚¯ã¨è£œå®Œ
            // (å…¥åŠ›ãŒ 'test.mp3' ã§ã‚‚ 'test' ã§ã‚‚ 'test.mp3' ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹)
            if (!name.toLowerCase().endsWith('.mp3')) {
                name += '.mp3';
            }
        
            if (!appData.files.includes(name)) {
                appData.files.push(name);
                saveData();
                
                // UIãƒªã‚»ãƒƒãƒˆ
                newFileNameInput.value = '';
                filePicker.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ‰‹å‹•é…ç½®ã®æ³¨æ„å–šèµ·ã‚’å«ã‚€ï¼‰
                alert(`ã€Œ${name}ã€ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚\n\nã€é‡è¦ã€‘\nå®Ÿéš›ã«å†ç”Ÿã™ã‚‹ã«ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’\nã€Œsoundã€ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ç½®ã„ã¦ãã ã•ã„ã€‚`);
            } else {
                alert(`ã€Œ${name}ã€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // 1. æ—¢å­˜ã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³
        addFileBtn.addEventListener('click', () => {
            registerFile(newFileNameInput.value);
        });

        // 2. ã€Œå‚ç…§ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        browseBtn.addEventListener('click', () => {
            filePicker.click();
        });

        // 3. ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ â†’ åå‰ã‚’å–å¾—ã—ã¦ç™»éŒ²
        filePicker.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // file.name ã«ã¯ "bgm01.mp3" ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«åãŒå…¥ã£ã¦ã„ã‚‹
                registerFile(file.name);
            }
        });

        // 2. ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
        function renderGroupSelects() {
            const currentMainVal = mainGroupSelect.value;
            const currentEditVal = editGroupSelect.value;

            mainGroupSelect.innerHTML = '';
            editGroupSelect.innerHTML = '<option value="">-- ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ --</option>';

            appData.groups.forEach((group, index) => {
                const op1 = document.createElement('option');
                op1.value = index;
                op1.textContent = `${group.name} (${group.files.length}å€‹)`;
                mainGroupSelect.appendChild(op1);

                const op2 = document.createElement('option');
                op2.value = index;
                op2.textContent = group.name;
                editGroupSelect.appendChild(op2);
            });

            if (currentMainVal && appData.groups[currentMainVal]) mainGroupSelect.value = currentMainVal;
            if (currentEditVal && appData.groups[currentEditVal]) editGroupSelect.value = currentEditVal;
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        createGroupBtn.addEventListener('click', () => {
            const name = newGroupNameInput.value.trim();
            if (name) {
                appData.groups.push({ name: name, files: [] });
                newGroupNameInput.value = '';
                saveData();
                editGroupSelect.value = appData.groups.length - 1;
                renderGroupEditor();
            }
        });

        deleteGroupBtn.addEventListener('click', () => {
            const idx = editGroupSelect.value;
            if (idx === "") return;
            if (confirm("ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                appData.groups.splice(idx, 1);
                saveData();
                groupEditorArea.classList.add('hidden');
            }
        });

        editGroupSelect.addEventListener('change', renderGroupEditor);

        function renderGroupEditor() {
            const idx = editGroupSelect.value;
            if (idx === "") {
                groupEditorArea.classList.add('hidden');
                return;
            }
            groupEditorArea.classList.remove('hidden');
            
            const targetGroup = appData.groups[idx];
            groupFileCheckboxes.innerHTML = '';

            appData.files.forEach(fileName => {
                const label = document.createElement('label');
                label.className = 'file-checkbox';
                const isChecked = targetGroup.files.includes(fileName);
                if (isChecked) label.classList.add('checked');

                label.innerHTML = `<input type="checkbox" value="${fileName}" ${isChecked ? 'checked' : ''}> ${fileName}`;
                
                label.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) label.classList.add('checked');
                    else label.classList.remove('checked');
                });

                groupFileCheckboxes.appendChild(label);
            });
        }

        saveGroupConfigBtn.addEventListener('click', () => {
            const idx = editGroupSelect.value;
            if (idx === "") return;

            const checkboxes = groupFileCheckboxes.querySelectorAll('input[type="checkbox"]');
            const selectedFiles = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selectedFiles.push(cb.value);
            });

            appData.groups[idx].files = selectedFiles;
            saveData();
            alert("ã‚°ãƒ«ãƒ¼ãƒ—å†…å®¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
        });

        // 3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›
        exportBtn.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(appData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sound_player_config.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if (loaded.files && loaded.groups) {
                        appData = loaded;
                        saveData();
                        alert("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
                    } else {
                        alert("ç„¡åŠ¹ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚");
                    }
                } catch (err) {
                    alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        /* * ============================================================
         * â–¶ï¸ å†ç”Ÿãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
         * ============================================================
         */
        document.getElementById('volDisplay').textContent = (volumeRange.value * 100).toFixed(0) + "%";
        document.getElementById('intervalDisplay').textContent = intervalRange.value + "ç§’";
        
        volumeRange.addEventListener('input', (e) => {
            document.getElementById('volDisplay').textContent = (e.target.value * 100).toFixed(0) + "%";
        });
        intervalRange.addEventListener('input', (e) => {
            document.getElementById('intervalDisplay').textContent = e.target.value + "ç§’";
        });

        probModeRadios.forEach(r => {
            r.addEventListener('change', () => {
                if (r.value === 'linear') {
                    document.getElementById('linearSetting').classList.remove('hidden');
                    document.getElementById('exponentialSetting').classList.add('hidden');
                } else {
                    document.getElementById('linearSetting').classList.add('hidden');
                    document.getElementById('exponentialSetting').classList.remove('hidden');
                }
            });
        });

        startBtn.addEventListener('click', () => {
            if (isRunning) return;
            
            const groupIdx = mainGroupSelect.value;
            const targetFiles = appData.groups[groupIdx]?.files;

            if (!targetFiles || targetFiles.length === 0) {
                alert("é¸æŠã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šã‚¨ãƒªã‚¢ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚");
                return;
            }

            isRunning = true;
            toggleButtons(true);
            currentProbability = parseFloat(initProbInput.value);
            lastPlayedFile = null;
            
            updateStatus("é–‹å§‹: åˆ¤å®šå¾…ã¡...");
            const wait = parseFloat(intervalRange.value) * 1000;
            timerId = setTimeout(processLoop, wait);
        });

        stopBtn.addEventListener('click', () => {
            if (!isRunning) return;
            isRunning = false;
            clearTimeout(timerId);
            toggleButtons(false);
            updateStatus("åœæ­¢ã—ã¾ã—ãŸ");
        });

        function processLoop() {
            if (!isRunning) return;

            const dice = Math.random() * 100;
            if (dice < currentProbability) {
                updateStatus("â™ª å†ç”Ÿä¸­ (åˆ¤å®šåœæ­¢)");
                playSound(() => {
                    // å†ç”Ÿçµ‚äº†å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    if (!isRunning) return; // åœæ­¢ã•ã‚Œã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
                    currentProbability = parseFloat(initProbInput.value);
                    
                    // å°‘ã—é–“éš”ã‚’ç©ºã‘ã¦å†é–‹ã—ãŸã„å ´åˆï¼ˆä¾‹ãˆã°å†ç”Ÿçµ‚äº†å¾Œ1ç§’å¾…ã¤ï¼‰
                    timerId = setTimeout(() => {
                        updateStatus("åˆ¤å®šå†é–‹");
                        processLoop();
                    }, 500); 
                });
            } else {
                increaseProbability();
                updateStatus(`... (æ¬¡: ${currentProbability.toFixed(1)}%)`);
                
                const base = parseFloat(intervalRange.value) * 1000;
                const jitter = Math.random() * 500;
                timerId = setTimeout(processLoop, base + jitter);
            }
        }

        function increaseProbability() {
            const mode = document.querySelector('input[name="probMode"]:checked').value;
            if (mode === 'linear') {
                currentProbability += parseFloat(stepProbInput.value);
            } else {
                currentProbability *= parseFloat(multiProbInput.value);
            }
            if (currentProbability > 100) currentProbability = 100;
        }

        function playSound(onEndedCallback) {
            const groupIdx = mainGroupSelect.value;
            const fileList = appData.groups[groupIdx].files;
            
            if (fileList.length === 0) {
                if(onEndedCallback) onEndedCallback(); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯å³æ¬¡ã¸
                return;
            };

            let selectedFile;
            const useReduce = reduceRepeatCheck.checked;

            if (useReduce && lastPlayedFile && fileList.includes(lastPlayedFile) && fileList.length > 1) {
                const weights = fileList.map(f => (f === lastPlayedFile) ? 0.5 : 1.0);
                const totalW = weights.reduce((a, b) => a + b, 0);
                let r = Math.random() * totalW;
                
                for (let i = 0; i < fileList.length; i++) {
                    if (r < weights[i]) {
                        selectedFile = fileList[i];
                        break;
                    }
                    r -= weights[i];
                }
            } else {
                const rIdx = Math.floor(Math.random() * fileList.length);
                selectedFile = fileList[rIdx];
            }

            if (!selectedFile) selectedFile = fileList[0];
            lastPlayedFile = selectedFile;

            const audio = new Audio(`./sound/${selectedFile}`);
            audio.volume = parseFloat(volumeRange.value);
            
            audio.addEventListener('ended', () => {
                if(onEndedCallback && typeof onEndedCallback === 'function') onEndedCallback();
            });

            // ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾ç­–ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆãªã©æ°¸é ã«æ­¢ã¾ã‚‹ã®ã‚’é˜²ãï¼‰
            audio.addEventListener('error', (e) => {
                console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${selectedFile} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å°‘ã—å¾…ã£ã¦æ¬¡ã¸é€²ã‚ã‚‹
                setTimeout(() => {
                    if(onEndedCallback) onEndedCallback();
                }, 1000); 
            });

            audio.play().catch(e => {
                console.error("å†ç”Ÿé–‹å§‹ã‚¨ãƒ©ãƒ¼", e);
                if(onEndedCallback) onEndedCallback();
            });
        }

        function toggleButtons(running) {
            startBtn.disabled = running;
            stopBtn.disabled = !running;
        }
        function updateStatus(msg) {
            statusDisplay.textContent = msg;
        }

        initApp();
    </script>
</body>
</html>